import streamlit as st
from modules.image_gen import generate_image
from modules.audio_handler import record_audio
from modules.share_utils import generate_download_link, generate_instagram_link

st.set_page_config(page_title="GPT-4o Voice to Ghibli", layout="centered")
st.title("🎤🖼️ Voice to Ghibli-style Anime")

st.markdown("Describe your scene or **record your voice** below.")

text_prompt = st.text_input("Text Prompt")
audio_blob = record_audio()
audio_prompt = ""

if audio_blob:
    st.audio(audio_blob, format="audio/wav")
    audio_prompt = "audio-based fantasy scene"

final_prompt = text_prompt.strip() or audio_prompt

if st.button("🎨 Generate Image") and final_prompt:
    with st.spinner("Generating Ghibli-style image..."):
        try:
            image_url = generate_image(final_prompt)
            st.image(image_url, caption="🖌️ Generated by GPT-4o", use_container_width=True)
            st.markdown(generate_download_link(image_url), unsafe_allow_html=True)
            st.markdown(generate_instagram_link(image_url), unsafe_allow_html=True)
        except Exception as e:
            st.error("Something went wrong with image generation.")
            st.exception(e)