
import streamlit as st
import boto3
import uuid
from modules.image_gen import generate_image
from modules.share_utils import generate_download_link, generate_instagram_link

st.set_page_config(page_title="GPT-4o Ghibli Generator", layout="centered")
st.title("ðŸŒ¸ GPT-4o Prompt/Image to Ghibli-style Anime")

email = st.secrets.get("USER_EMAIL", "unknown_user")

s3 = boto3.client("s3",
    aws_access_key_id=st.secrets["AWS_ACCESS_KEY_ID"],
    aws_secret_access_key=st.secrets["AWS_SECRET_ACCESS_KEY"],
    region_name=st.secrets["AWS_REGION"]
)
bucket_name = st.secrets["S3_BUCKET"]

def upload_to_s3(file_bytes, filename):
    s3.put_object(Bucket=bucket_name, Key=filename, Body=file_bytes)
    return f"https://{bucket_name}.s3.amazonaws.com/{filename}"

st.markdown("Upload an image or describe your scene below.")

uploaded_file = st.file_uploader("Upload an image (optional)", type=["jpg", "jpeg", "png"])
text_prompt = st.text_input("Text Prompt")

final_prompt = text_prompt.strip()

if st.button("ðŸŽ¨ Generate Image") and final_prompt:
    with st.spinner("Generating image..."):
        try:
            image_url = generate_image(final_prompt)
            st.image(image_url, caption="ðŸŽ¨ Generated by GPT-4o", use_container_width=True)
            st.markdown(generate_download_link(image_url), unsafe_allow_html=True)
            st.markdown(generate_instagram_link(image_url), unsafe_allow_html=True)
            img_id = str(uuid.uuid4())
            s3.put_object(Bucket=bucket_name, Key=f"generated/{email}/{img_id}.txt", Body=image_url)
        except Exception as e:
            st.error("Something went wrong during image generation.")
            st.exception(e)

if uploaded_file:
    st.image(uploaded_file, caption="ðŸ“¤ Uploaded Image", use_container_width=True)
    with st.spinner("Uploading to S3..."):
        file_bytes = uploaded_file.getvalue()
        filename = f"uploads/{email}/{uploaded_file.name}"
        s3_url = upload_to_s3(file_bytes, filename)
        st.success(f"Uploaded to S3: {s3_url}")
