import streamlit as st
from modules.image_gen import generate_image
from modules.audio_handler import record_audio
from modules.share_utils import generate_download_link, generate_instagram_link

st.set_page_config(page_title="GPT-4o Voice to Ghibli", layout="centered")
st.title("🎤🖼️ Voice to Ghibli-style Anime")

st.markdown("Describe your scene or **record your voice** below. You can either type or record, and we’ll generate a Ghibli-style animation!")

# User input
text_prompt = st.text_input("Text Prompt ✍️", placeholder="e.g. A cat sleeping under cherry blossoms")
audio_blob = record_audio()

# Display audio preview if recorded
if audio_blob:
    st.audio(audio_blob, format="audio/wav")

# Determine final prompt
final_prompt = text_prompt.strip() if text_prompt.strip() else "a peaceful nature scene for anime style"

# Disable button if no input at all
can_generate = bool(text_prompt.strip()) or bool(audio_blob)

if st.button("🎨 Generate Ghibli Image", disabled=not can_generate):
    with st.spinner("Creating magic..."):
        try:
            image_url = generate_image(final_prompt)
            st.image(image_url, caption="🖌️ Generated by GPT-4o", use_container_width=True)
            st.markdown(generate_download_link(image_url), unsafe_allow_html=True)
            st.markdown(generate_instagram_link(image_url), unsafe_allow_html=True)
        except Exception as e:
            st.error("Something went wrong with image generation.")
            st.exception(e)
