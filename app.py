import streamlit as st
import openai
from streamlit.components.v1 import html

st.set_page_config(page_title="GPT-4o Image Creator", layout="centered")
openai.api_key = st.secrets.get("OPENAI_API_KEY")

SAFE_KEYWORDS = ["cute", "digital", "cartoon", "illustration", "fantasy", "nature", "AI art"]

def sanitize_prompt(prompt):
    return f"A {SAFE_KEYWORDS[0]} {prompt.strip()}. Rendered as an {SAFE_KEYWORDS[2]} in soft tone."

def generate_image(prompt):
    clean_prompt = sanitize_prompt(prompt)
    response = openai.Image.create(
        prompt=f"Create Ghibli Style photos for this user prompt: {clean_prompt}",
        n=1,
        size="1024x1024"
    )
    return response["data"][0]["url"]

def image_to_download_link(img_url):
    return f'<a href="{img_url}" download="gpt4o_image.png" target="_blank">📥 Download Image</a>'

def share_to_twitter_url(prompt):
    return f"https://twitter.com/intent/tweet?text=Check+out+this+image+generated+by+GPT-4o:+{prompt}"

def share_to_instagram_instruction():
    return ("To share on Instagram: tap and hold the image on mobile to save it, "
            "then post as a story or feed image in the Instagram app.")

# ────────────────────────────────────────────────

st.title("🖼️ GPT-4o Image Creator")

prompt = st.text_area("Enter your image description")

# 🎙️ Voice Record Button (non-functional placeholder)
st.markdown("**🎙️ Record Voice Prompt (Mobile Placeholder)**")
html(
    """
    <script>
    function recordPrompt() {
        alert("Voice recording isn't active yet. Please type your prompt.");
    }
    </script>
    <button onclick="recordPrompt()">🎤 Record Prompt</button>
    """,
    height=80
)

if st.button("Generate Image") and prompt.strip():
    with st.spinner("Generating image..."):
        try:
            img_url = generate_image(prompt)
            st.image(img_url, caption="Generated by GPT-4o", use_container_width=True)
            st.markdown(image_to_download_link(img_url), unsafe_allow_html=True)
            st.markdown(f"[🔗 Share on Twitter]({share_to_twitter_url(prompt)})")
            st.markdown("📸 " + share_to_instagram_instruction())
        except openai.error.InvalidRequestError as e:
            st.error("⚠️ OpenAI flagged this prompt.")
            st.info("Try rephrasing with simpler, safer language.")
